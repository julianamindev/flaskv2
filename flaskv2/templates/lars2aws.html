{% extends "base/home/home-base.html" %}

{% block title %}DevOps Cockpit - LARS2AWS{% endblock%}

{% block extra_head %}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='css/extras/lars2aws-tab-styles.css') }}" rel="stylesheet" />
{% endblock %}

{% block main %}
<main>
  <div class="container-fluid px-2 px-md-3 pt-4">

    <h1 class="h3 mb-3">LARS → AWS</h1>

    <!-- inline alert area -->
    <div id="l2a-alerts"></div>

    <div class="alert alert-info mb-4" role="alert">
      <div class="fw-semibold mb-1">How it works</div>
      <ul class="mb-0">
        <li>Pick a <b>Stream</b>, then choose a <b>Build</b> (lists load on demand).</li>
        <li>If your stream isn’t listed, toggle <b>Manual stream</b>, enter the exact stream name, and click <b>Use stream</b>. We’ll validate it against LARS and then load its builds.</li>
        <li>Review the selected builds below, set the S3 destination suffix, then <b>Upload to S3</b>.</li>
      </ul>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs tabs-accent" id="appsTab" role="tablist">
      {% for app in APPS %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ app|lower }}-tab"
                data-bs-toggle="tab" data-bs-target="#{{ app|lower }}-pane"
                type="button" role="tab" aria-controls="{{ app|lower }}-pane"
                aria-selected="{{ 'true' if loop.first else 'false' }}">{{ app }}</button>
      </li>
      {% endfor %}
    </ul>

    <!-- Single form that will submit all selections -->
    <form id="lars2awsForm" action="#" method="post" class="mt-3">
      {{ form.hidden_tag() }}

      <div class="tab-content" id="appsTabContent">
        {% for app in APPS %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ app|lower }}-pane" role="tabpanel" aria-labelledby="{{ app|lower }}-tab">

          <div class="row g-3">
            <!-- STREAMS -->
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label mb-0" for="{{ app|lower }}-stream">Streams</label>

                <div class="form-check form-switch ms-3">
                  <input class="form-check-input" type="checkbox" id="{{ app|lower }}-manual-toggle">
                  <label class="form-check-label" for="{{ app|lower }}-manual-toggle">Manual stream</label>
                </div>
              </div>

              <!-- Normal Select2 for streams (hidden in manual mode) -->
              <select class="form-select select2 stream-select"
                      id="{{ app|lower }}-stream"
                      name="{{ app|lower }}_stream"
                      data-app="{{ app }}"
                      data-placeholder="Choose a stream">
                <option></option>
              </select>

              <!-- Manual stream entry (shown in manual mode) -->
              <div class="input-group mt-2 d-none" id="{{ app|lower }}-manual-stream-wrap">
                <input type="text"
                       class="form-control"
                       id="{{ app|lower }}-manual-input"
                       placeholder="Enter exact stream (e.g., REL_2025_08, intINT_2025_08)">
                <button class="btn btn-outline-primary" type="button" id="{{ app|lower }}-manual-validate">
                  Use stream
                </button>
              </div>
            </div>

            <!-- BUILDS -->
            <div class="col-md-6">
              <label class="form-label" for="{{ app|lower }}-build">Builds</label>
              <select class="form-select select2 build-select"
                      id="{{ app|lower }}-build"
                      name="{{ app|lower }}_build"
                      data-app="{{ app }}"
                      data-placeholder="Choose a build">
                <option></option>
              </select>
            </div>
          </div>

        </div>
        {% endfor %}
      </div>

      <!-- Summary (Form 2) -->
      <hr class="my-4">

      <h2 class="h5 mb-3">Selected builds</h2>
      <div class="row g-3">
        {% for app in APPS %}
        <div class="col-md-6 col-lg-3">
          <label class="form-label" for="summary-{{ app|lower }}">{{ app }}</label>
          <input type="text" id="summary-{{ app|lower }}" class="form-control" placeholder="(none)" readonly>
          <!-- Hidden inputs that actually submit -->
          <input type="hidden" name="summary_{{ app|lower }}_stream" id="hidden-{{ app|lower }}-stream">
          <input type="hidden" name="summary_{{ app|lower }}_build"  id="hidden-{{ app|lower }}-build">
        </div>
        {% endfor %}
      </div>

      <!-- Path prefix -->
      <div class="mt-4">
        <label class="form-label" for="migops-lars-input">S3 Destination</label>
        <div class="input-group">
          <span class="input-group-text">migops/LARS/</span>
          <input
            type="text"
            id="migops-lars-input"
            name="migops_lars_suffix"
            class="form-control"
            placeholder="e.g., MT/month or INT/intMSCM..." />
        </div>
        <input type="hidden" name="migops_lars_path" id="migops-lars-path">
      </div>

      <div class="mt-4 d-flex gap-2">
        <button type="submit" class="btn btn-dark" id="upload-btn">Upload to S3</button>
        <button type="button" class="btn btn-outline-secondary" id="clear-selections">Clear fields</button>
      </div>
    </form>

  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
<script>
  window.L2A = { APPS: {{ APPS|tojson|safe }} };
</script>
<script src="{{ url_for('static', filename='js/lars2aws.js') }}" defer></script>
{% endblock %}
