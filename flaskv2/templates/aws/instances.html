{% extends "base/home/home-base.html" %}
{% block title %}Stacks{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block main %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <h1 class="h3 mb-0">Stacks</h1>
    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Refresh</button>
  </div>

  <!-- Summary header -->
  <div class="mb-3">
    <div class="d-flex align-items-center flex-wrap gap-2">
      <span class="badge text-bg-primary fs-6">Total: {{ total_stacks }}</span>
      {% set state_badge = {'Running':'success','Off':'secondary','Opening':'warning','Closing':'warning','Degraded':'danger','Unknown':'secondary'} %}
      {% for st, cnt in state_counts.items() %}
        {% if cnt > 0 %}
          <span class="badge text-bg-{{ state_badge.get(st, 'secondary') }}">{{ st }}: {{ cnt }}</span>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Filters row -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <div class="btn-group" role="group" aria-label="Numbering filter">
      <input type="radio" class="btn-check" name="series" id="series-all" value="all" checked>
      <label class="btn btn-sm btn-outline-primary" for="series-all">All</label>
      <input type="radio" class="btn-check" name="series" id="series-fsm" value="fsm"><label class="btn btn-sm btn-outline-primary" for="series-fsm">FSM</label>
      <input type="radio" class="btn-check" name="series" id="series-ghr" value="ghr"><label class="btn btn-sm btn-outline-primary" for="series-ghr">GHR</label>
      <input type="radio" class="btn-check" name="series" id="series-stmt" value="stmt"><label class="btn btn-sm btn-outline-primary" for="series-stmt">ST2MT</label>
      <input type="radio" class="btn-check" name="series" id="series-archive" value="archive"><label class="btn btn-sm btn-outline-primary" for="series-archive">Archive</label>
      <input type="radio" class="btn-check" name="series" id="series-phi" value="phi"><label class="btn btn-sm btn-outline-primary" for="series-phi">PHI</label>
      <input type="radio" class="btn-check" name="series" id="series-devqa" value="devqa"><label class="btn btn-sm btn-outline-primary" for="series-devqa">Dev/QA</label>
      <input type="radio" class="btn-check" name="series" id="series-lease" value="lease"><label class="btn btn-sm btn-outline-primary" for="series-lease">Lease</label>
      <input type="radio" class="btn-check" name="series" id="series-test" value="test"><label class="btn btn-sm btn-outline-primary" for="series-test">StackService/Test</label>
    </div>

    <!-- ALWAYSON toggle -->
    <div class="btn-group" role="group" aria-label="AlwaysOn">
      <input type="checkbox" class="btn-check" id="filter-alwayson" autocomplete="off">
      <label class="btn btn-sm btn-outline-success" for="filter-alwayson">ALWAYSON</label>
    </div>

    <select id="filter-state" class="form-select form-select-sm" style="min-width: 160px;">
      <option value="">All States</option>
      {% for st in states %}<option value="{{ st }}">{{ st }}</option>{% endfor %}
    </select>

    <!-- Live count -->
    <span id="shown-count" class="ms-auto text-muted small">Showing 0 of {{ total_stacks }}</span>
  </div>

  <div class="table-responsive border rounded">
    <table id="stacks-table" class="table table-hover align-middle mb-0">
      <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
        <tr>
          <th>Stack name</th>
          <th>Client</th>
          <th>State</th>
          <th>Always On</th>
          <th>Storage</th>
        </tr>
      </thead>
      <tbody>
        {% set badge_map = {'Running':'success','Off':'secondary','Opening':'warning','Closing':'warning','Degraded':'danger','Unknown':'secondary'} %}
        {% for s in stacks %}
          {% set always_on = 'On' if s.alwayson in [True, 'On', 'ALWAYSON'] else 'Off' %}
          {% set always_badge = 'success' if always_on == 'On' else 'secondary' %}
          <tr data-stack="{{ s.name }}">
            <td class="fw-semibold">{{ s.name }}</td>
            <td>{{ s.client }}</td>
            <td><span class="badge text-bg-{{ badge_map.get(s.state, 'secondary') }}">{{ s.state }}</span></td>
            <td><span class="badge text-bg-{{ always_badge }}">{{ always_on }}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-dark view-storage-btn">
                <span class="spinner-border spinner-border-sm me-1 d-none" role="status" aria-hidden="true"></span>
                View
              </button>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="text-muted">No stacks found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Storage Modal (DB live; stacked bar) -->
<div class="modal fade" id="storageModal" tabindex="-1" aria-labelledby="storageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="storageModalLabel">Storage - <span id="modalStackName"></span></h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="storage-note" class="alert alert-info py-2 px-3 small d-none"></div>

        <div class="card">
          <div class="card-header py-2">Database (INFORBCDB01Instance)</div>
          <div class="card-body">
            <canvas id="db-stacked"></canvas>
            <div id="empty-database" class="text-muted small d-none mt-2">No volumes found.</div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  let currentSeries = 'all';
  let currentState  = '';
  let onlyAlwaysOn  = false;
  const shownEl = document.getElementById('shown-count');

  const seriesRegex = {
    fsm:/^migops1\d{3}$/i, ghr:/^migops2\d{3}$/i, stmt:/^migops3\d{3}$/i,
    archive:/^migops4\d{3}$/i, phi:/^migops5\d{3}$/i,
    devqa:/^migops7\d{3}$/i, lease:/^migops8\d{3}$/i, test:/^migops\d{3}$/i
  };

  // Custom filter (series + state + ALWAYSON) scoped to this table
  DataTable.ext.search.push(function (settings, data) {
    if (!settings.nTable || settings.nTable.id !== 'stacks-table') return true;

    const stackName = data[0] || '';

    // Series
    if (currentSeries !== 'all') {
      const re = seriesRegex[currentSeries];
      if (!re || !re.test(stackName)) return false;
    }

    // State (exact)
    if (currentState) {
      const d = document.createElement('div'); d.innerHTML = data[2] || '';
      if (d.textContent.trim() !== currentState) return false;
    }

    // ALWAYSON (exact "On")
    if (onlyAlwaysOn) {
      const d2 = document.createElement('div'); d2.innerHTML = data[3] || '';
      if (d2.textContent.trim() !== 'On') return false;
    }

    return true;
  });

  // DataTable with one search box and pagination
  const table = new DataTable('#stacks-table', {
    layout: {
      topStart:   { search: { placeholder: 'Search stacksâ€¦' } },
      topEnd:     null,
      bottomStart:{ info: true, pageLength: { menu: [25, 50, 100, -1], labels: ['25','50','100','All'] } },
      bottomEnd:  { paging: { type: 'simple_numbers' } }
    },
    pageLength: 25,
    order: [[0, 'asc']],
    columnDefs: [
      { targets: 2, render: (data, type) => type === 'display' ? data : stripText(data) },
      { targets: 3, render: (data, type) => type === 'display' ? data : stripText(data) },
    ]
  });

  // Live "Showing N of TOTAL"
  function updateShown() {
    const info = table.page.info();
    shownEl.textContent = `Showing ${info.recordsDisplay} of ${info.recordsTotal}`;
  }
  table.on('draw', updateShown);
  updateShown();

  // Wire up filters
  document.querySelectorAll('input[name="series"]').forEach(r => {
    r.addEventListener('change', function () { currentSeries = this.value; table.draw(); });
  });
  document.getElementById('filter-state').addEventListener('change', function () {
    currentState = this.value; table.draw();
  });
  document.getElementById('filter-alwayson').addEventListener('change', function () {
    onlyAlwaysOn = this.checked; table.draw();
  });

  function stripText(html){ const div=document.createElement('div'); div.innerHTML=html; return div.textContent.trim(); }

  // ---- Storage modal logic (DB live via SSM, stacked bar) ----
  const modalEl = document.getElementById('storageModal');
  const bsModal = new bootstrap.Modal(modalEl);
  const modalStackNameEl = document.getElementById('modalStackName');
  const noteEl = document.getElementById('storage-note');
  let dbChart = null;

  function destroyDbChart() {
    if (dbChart) { try { dbChart.destroy(); } catch(e){} }
    dbChart = null;
  }

  function renderDbStacked(vols) {
    const emptyEl = document.getElementById('empty-database');
    const canvas  = document.getElementById('db-stacked');
    const ctx     = canvas.getContext('2d');

    if (!vols || vols.length === 0) {
      emptyEl.classList.remove('d-none');
      destroyDbChart();
      return;
    }
    emptyEl.classList.add('d-none');

    // Dynamic height so all drives are visible at once (no scroll)
    const perRow = 36; // px per drive
    const minH   = 160;
    canvas.style.height = Math.max(minH, vols.length * perRow) + 'px';

    const labels = vols.map(v => `${(v.drive || '(no letter)')}${v.label ? ' - ' + v.label : ''}`);
    const used   = vols.map(v => v.used_gib || 0);
    const free   = vols.map(v => v.free_gib || 0);

    destroyDbChart();
    dbChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Used (GiB)', data: used, stack: 'storage' },
          { label: 'Free (GiB)', data: free, stack: 'storage' }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} GiB` } }
        },
        scales: {
          x: { stacked: true, title: { display: true, text: 'GiB' } },
          y: { stacked: true }
        }
      }
    });
  }

  // Delegated click handler so it works across pagination/filter redraws
  const tableEl = document.getElementById('stacks-table');
  tableEl.addEventListener('click', async (e) => {
    const btn = e.target.closest('.view-storage-btn');
    if (!btn) return;

    const tr = btn.closest('tr');
    const stackName = tr?.getAttribute('data-stack');
    if (!stackName) return;

    // Spinner UX
    const spinner = btn.querySelector('.spinner-border');
    spinner?.classList.remove('d-none');
    btn.disabled = true;

    // Reset modal
    modalStackNameEl.textContent = stackName;
    noteEl.classList.add('d-none');
    destroyDbChart();
    document.getElementById('empty-database').classList.add('d-none');

    try {
      const resp = await fetch(`/aws/stack/${encodeURIComponent(stackName)}/storage-db-live`);
      const payload = await resp.json();
      if (!resp.ok) throw new Error(payload.error || `HTTP ${resp.status}`);

      if (payload.note) {
        noteEl.textContent = payload.note;
        noteEl.classList.remove('d-none');
      }
      renderDbStacked(payload.volumes || []);
      bsModal.show();
    } catch (err) {
      noteEl.textContent = `Failed to load DB storage: ${err.message || err}`;
      noteEl.classList.remove('d-none');
      bsModal.show();
    } finally {
      spinner?.classList.add('d-none');
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}
