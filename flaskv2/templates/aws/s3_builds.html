{% extends "base/home/home-base.html" %}
{% block title %}S3 Builds{% endblock %}

{% block extra_head %}
  <!-- DataTables Bootstrap 5 styles -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block main %}
<div class="container-fluid py-3">
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
        <h4 class="mb-0">S3 Builds (Test Data)</h4>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Refresh</button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table id="buildsTable" class="table table-striped table-hover w-100 align-middle">
            <thead>
            <tr>
                <th style="width:2rem;"></th>
                <th>Prefix</th>
                <th>Category</th>
                <th class="text-end">Files</th>
                <th class="text-end">Inject</th>
            </tr>
            </thead>
            <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Inject Builds Modal -->
<div class="modal fade" id="injectModal" tabindex="-1" aria-labelledby="injectModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="injectModalLabel">
          Inject builds from <code id="inj-prefix">—</code>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Step indicator -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="small text-muted" id="inj-step-indicator">Step 1 of 3 — Select target stack</div>
          <div class="badge bg-light text-dark fw-normal" id="inj-context">
            <span class="me-2">Destination:</span><code>/opt/infor/landmark/tmp</code>
          </div>
        </div>

        <!-- Step 1: pick a stack -->
        <div id="inj-step-1">
          <div class="d-flex align-items-center gap-2 mb-2">
            <input id="stackFilter" type="search" class="form-control form-control-sm" placeholder="Filter stacks… (name, id, env)">
            <span class="text-muted small">Running Landmark stacks</span>
          </div>
          <div class="table-responsive border rounded">
            <table class="table table-sm align-middle mb-0" id="stacksTable">
              <thead class="table-light">
                <tr>
                  <th style="width:2.2rem;"></th>
                  <th>Name</th>
                  <th>Instance ID</th>
                  <th>Env</th>
                  <th>Region</th>
                  <th>Uptime</th>
                </tr>
              </thead>
              <tbody><!-- filled by JS --></tbody>
            </table>
          </div>
          <div class="small text-muted mt-2" id="stacksSummary">0 stacks</div>
        </div>

        <!-- Step 2: choose files -->
        <div id="inj-step-2" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Select files to inject</div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-sm btn-outline-secondary" id="selectAllFiles">Select all</button>
              <button class="btn btn-sm btn-outline-secondary" id="clearAllFiles">Clear all</button>
            </div>
          </div>
          <div class="table-responsive border rounded">
            <table class="table table-sm align-middle mb-0" id="filesTable">
              <thead class="table-light">
                <tr>
                  <th style="width:2rem;"></th>
                  <th>File</th>
                  <th>S3 URI</th>
                  <th>Metadata</th>
                </tr>
              </thead>
              <tbody><!-- filled by JS --></tbody>
            </table>
          </div>
          <div class="small text-muted mt-2" id="filesSummary">0 selected</div>
        </div>

        <!-- Step 3: confirm -->
        <div id="inj-step-3" class="d-none">
          <div class="mb-3">
            <div class="fw-semibold mb-1">Summary</div>
            <ul class="mb-0">
              <li>Stack: <code id="sum-stack">—</code></li>
              <li>Prefix: <code id="sum-prefix">—</code></li>
              <li>Destination: <code>/opt/infor/landmark/tmp</code></li>
              <li>Files (<span id="sum-count">0</span>):</li>
            </ul>
            <div class="border rounded p-2 mt-2" style="max-height: 180px; overflow:auto" id="sum-files"><!-- filled by JS --></div>
          </div>
          <div class="alert alert-warning mb-0">
            Pre-clear will remove if present: <code>Install-LMMIG.jar</code>, <code>Install-LMHCM.jar</code>, <code>Install-LMIEFIN.jar</code>, <code>LANDMARK.jar</code>, <code>grid-installer.jar</code>, <code>mt-dependencies.txt</code>, <code>mt_dependencies.txt</code>.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="text-muted small me-auto" id="inj-hint"></div>
        <button type="button" class="btn btn-outline-secondary" id="inj-back" disabled>Back</button>
        <button type="button" class="btn btn-primary" id="inj-next">Next</button>
        <button type="button" class="btn btn-success d-none" id="inj-submit">Inject Builds</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}

  <!-- libraries -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>  

  <!-- DataTables + Bootstrap 5 integration -->
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>

  <!-- page config (Jinja -> JS handoff) -->
  <script>
    window.S3B = {
      PREFIX_MAP: {{ (prefix_map | default({})) | tojson | safe }},
      BUCKET: "migops",
      ROOT: "LARS"
    };
  </script>

  <!-- main JS in js/aws/s3-builds.js -->
  <script src="{{ url_for('static', filename='js/aws/s3_builds.js') }}" defer></script>

  {% endblock %}
