{% extends "base/home/home-base.html" %}
{% block title %}S3 Builds{% endblock %}

{% block extra_head %}
  <!-- DataTables Bootstrap 5 styles -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block main %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
    <h4 class="mb-0">S3 Builds (Test Data)</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Refresh</button>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <table id="buildsTable" class="table table-striped table-hover w-100 align-middle">
        <thead>
        <tr>
          <th style="width:2rem;"></th>     <!-- expand control -->
          <th>Prefix</th>
          <th>Category</th>
          <th class="text-end">Files</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_scripts %}

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>  

<!-- DataTables + Bootstrap 5 integration -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>

<script>
    // Files that should show a version in the Metadata column
    const NEEDS_META_SET = new Set([
        "Install-LMMIG.jar",
        "Install-LMIEFIN.jar",
        "Install-LMHCM.jar",
        "LANDMARK.jar",
        "grid-installer.jar",
    ]);
    // Others like MIG_scripts.jar, mt_dependencies.txt will show "‚Äî"



    // Parse (since we pre-serialized in the route):
    const PREFIX_MAP = {{ (prefix_map | default({})) | tojson | safe }};

    const BUCKET = "migops";
    const ROOT   = "LARS";

    const rows = Object.entries(PREFIX_MAP).map(([prefix, files]) => {
        const isRoot = (prefix === "LARS/" || prefix === "" || prefix === "/");
        return {
            displayPrefix: isRoot ? "LARS/" : prefix,
            category:      isRoot ? "ROOT"  : prefix.split("/")[0],
            keyPrefix:     isRoot ? ""      : prefix, // used to build s3://migops/LARS/<keyPrefix>...
            files,
            files_count:   files.length
        };
    });    

  // Child row HTML (includes Metadata column between S3 URI and Actions)
    function renderChild(row) {
        const s3Base = `s3://${BUCKET}/${ROOT}/${row.keyPrefix}`; // keyPrefix "" => ends with /
        const fileRows = row.files.map(name => {
            const s3Uri  = s3Base + name;
            const relKey = `${row.keyPrefix}${name}`; // relative to LARS/
            const needs  = NEEDS_META_SET.has(name);
            return `
            <tr>
                <td class="py-1">${name}</td>
                <td class="py-1"><code class="small">${s3Uri}</code></td>
                <td class="py-1 meta-cell" data-key="${relKey}">${needs ? "‚Ä¶" : "‚Äî"}</td>
                <td class="py-1 text-end">
                <button class="btn btn-sm btn-outline-secondary" data-copy="${s3Uri}">Copy S3 URI</button>
                </td>
            </tr>`;
        }).join("");

        return `
        <div class="p-2">
            <div class="fw-semibold mb-2">Files in <span class="text-nowrap"><code>${row.displayPrefix}</code></span></div>
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                <thead>
                    <tr>
                    <th>File</th>
                    <th>S3 URI</th>
                    <th>Metadata</th>
                    <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>${fileRows || `<tr><td colspan="4" class="text-muted">No files</td></tr>`}</tbody>
                </table>
            </div>
        </div>`;
    }

  // Fill Metadata cells by calling the API for needed files
    function hydrateMetaCellsFor(trElem) {
        const $child = $(trElem).next("tr"); // DataTables puts child in next TR
        $child.find("td.meta-cell").each(function () {
            const td   = this;
            const key  = td.getAttribute("data-key") || "";
            if (!key) { td.textContent = "‚Äî"; return; }
            const base = key.split("/").pop();
            if (!NEEDS_META_SET.has(base)) { td.textContent = "‚Äî"; return; }

            td.textContent = "‚Ä¶";
            fetch(`/api/s3/object_meta?key=${encodeURIComponent(key)}`)
            .then(r => r.json())
            .then(({ ok, metadata }) => {
                td.textContent = (ok && metadata && metadata.version) ? metadata.version : "‚Äî";
            })
            .catch(() => { td.textContent = "‚Äî"; });
        });
    }

    // Copy buttons (event delegation)
    document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-copy]");
        if (!btn) return;
        const text = btn.getAttribute("data-copy");
        navigator.clipboard.writeText(text).then(() => {
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = "Copy S3 URI"), 1200);
        }).catch(() => {
            alert("Copy failed. You can select the URI text manually.");
        });
    });

    // DataTable init + expand handling
    $(function () {
        const dt = $('#buildsTable').DataTable({
            data: rows,
            columns: [
            { data: null, orderable: false, className: "dt-control", defaultContent: "" },
            { data: "displayPrefix", render: d => `<span class="me-1">üìÅ</span><code>${d}</code>` },
            { data: "category" },
            { data: "files_count", className: "text-end", render: d => d.toLocaleString() }
            ],
            order: [[1, "asc"]],
            paging: true,
            searching: true
        });

        $('#buildsTable tbody').on('click', 'td.dt-control', function () {
            const tr  = $(this).closest('tr');
            const row = dt.row(tr);
            if (row.child.isShown()) {
                row.child.hide();
                tr.removeClass('shown');
            } else {
                row.child(renderChild(row.data())).show();
                tr.addClass('shown');
                hydrateMetaCellsFor(tr[0]); // fetch versions for this child panel
            }
        });
    });
</script>
{% endblock %}
